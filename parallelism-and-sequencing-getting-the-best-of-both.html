<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div class="loading">Loading...</div>
    <div class="errors"></div>
    <script>
        function get(url) {
            // Return a new promise.
            return new Promise(function(resolve, reject) {
                // Do the usual XHR stuff
                var req = new XMLHttpRequest();
                req.open('GET', url);

                req.onload = function() {
                    // This is called even on 404 etc
                    // so check the status
                    if (req.status == 200) {
                        // Resolve the promise with the response text
                        resolve(req.response);
                    } else {
                        // Otherwise reject with the status text
                        // which will hopefully be a meaningful error
                        reject(Error(req.statusText));
                    }
                };

                // Handle network errors
                req.onerror = function() {
                    reject(Error("Network Error"));
                };

                // Make the request
                req.send();
            });
        }


        function getJSON(url) {
            return get(url).then(JSON.parse);
        }

        function addHtmlToPage(text) {
            var node = document.createElement("h3"); // Create a <li> node
            var textnode = document.createTextNode(text); // Create a text node
            node.appendChild(textnode); // Append the text to <li>
            document.querySelector(".errors").appendChild(node);
        }


        try {
            getJSON('story.json').then((response) => {
                let story;
                story = response[0]
                addHtmlToPage(story.title);


                //Parallelism
                story.urls.forEach(function(chapterUrl) {
                    var chapter = getJSON(chapterUrl).then((res) => {
                        addHtmlToPage(JSON.stringify(res));
                        console.log(res)

                    });
                });



                // Start off with a promise that always resolves
                var sequence = Promise.resolve();

                // // Loop through our chapter urls
                // story.urls.forEach(function(chapterUrl) {
                //         // Add these actions to the end of the sequence
                //         sequence = sequence.then(function() {
                //             return getJSON(chapterUrl);
                //         }).then(function(chapter) {
                //             addHtmlToPage(JSON.stringify(chapter));
                //         });
                //     })
                // Loop through our chapter urls
                story.urls.forEach(function(chapterUrl) {
                    // Add these actions to the end of the sequence
                    sequence = sequence.then(function() {
                        console.log(chapterUrl)
                        return getJSON(chapterUrl);
                    }).then(function(chapter) {
                        addHtmlToPage(JSON.stringify(chapter));
                    });
                })



            });

        } catch (err) {
            addHtmlToPage("Argh, broken: " + err.message);
        }







        document.querySelector('.loading').style.display = 'none'
    </script>
</body>


</html>